<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVET - Inventory</title>
</head>
<style>
    * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
    }

    body {
        height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        line-height: 1.5;
    }

    .main {
        width: 100vw;
        display: flex;
        height: 92vh;
    }

    .content {
        width: 85vw;
        padding: 20px;
    }

    .folders {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .inventory-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 5px;
        overflow: hidden;
    }

    .inventory-table th {
        background-color: #2E7D32;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
    }

    .inventory-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #ddd;
        font-size: 0.9rem;
        color: #333;
    }

    .inventory-table tbody tr:hover {
        background-color: #f5f5f5;
    }

    .inventory-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .inventory-table td:last-child {
        white-space: nowrap;
        min-width: 120px;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
    }

    .action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        font-family: inherit;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .edit-btn {
        background-color: #4CAF50;
        color: white;
    }

    .delete-btn {
        background-color: #f44336;
        color: white;
    }

    .action-btn:hover {
        opacity: 0.8;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: none;
        width: 95%;
        max-width: 900px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        max-height: 85vh;
        overflow-y: auto;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        margin-top: -10px;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }

    .modal h2 {
        margin-bottom: 20px;
        color: #2E7D32;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
    }

    .btn-primary {
        background-color: #2E7D32;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-danger {
        background-color: #f44336;
        color: white;
    }

    .btn:hover {
        opacity: 0.9;
    }

    .manage-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .manage-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .manage-item h4 {
        color: #2E7D32;
        margin-bottom: 10px;
    }

    .manage-item button {
        background-color: #2E7D32;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-right: 5px;
        margin-top: 5px;
    }

    .manage-item button:hover {
        opacity: 0.8;
    }

    .item-list {
        height: 180px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        background: white;
    }

    .item-entry {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        gap: 10px;
    }

    .item-entry:last-child {
        border-bottom: none;
    }

    .item-name {
        font-weight: 500;
        flex: 1;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .item-actions {
        display: flex;
        gap: 5px;
        flex-shrink: 0;
        align-items: flex-start;
    }

    .item-actions button {
        padding: 4px 10px;
        font-size: 11px;
        margin: 0;
        white-space: nowrap;
    }

    .btn-edit {
        background-color: #4CAF50;
    }

    .btn-delete {
        background-color: #f44336;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .form-row-triple {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
    }

    .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .confirmation-modal .modal-content {
        max-width: 400px;
        text-align: center;
    }

    .confirmation-modal h3 {
        color: #f44336;
        margin-bottom: 15px;
    }

    .confirmation-modal p {
        margin-bottom: 20px;
        color: #666;
    }

    .hidden {
        display: none;
    }
</style>
<body>

    {% include 'partials/navbar.html' %}

    <div class="main">

        {% include 'partials/tvet_sidebar.html' %}

        <div class="content">
            <div class="folders">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="search" id="searchInput" placeholder="Search materials..." style="padding: 6px 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; width: 250px;">
                    <select id="folderSelect" style="padding: 5px 10px;font-size: 1rem;margin-right: 5px;">
                        <option value="">All Folders</option>
                    </select>
                    {% if user_type == 'admin' %}
                    <button id="manageBtn" style="padding: 6px 10px;font-size: 1rem;background-color: #FF9800;color: white;border: none;border-radius: 5px;">Manage</button>
                    {% endif %}
                </div>

                 <button id="exportBtn" style="padding: 6px 10px;font-size: 1rem;background-color: #2E7D32;color: white;border: none;border-radius: 5px;cursor: pointer;margin-left:8px;" onclick="exportToPDF()">Export PDF</button>
                 <button id="addMaterialBtn" style="padding: 6px 10px;font-size: 1rem;background-color: #4CAF50;color: white;border: none;border-radius: 5px;">Add Material</button>
            </div>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Core Competency</th>
                        <th>Category</th>
                        <th>Item</th>
                        <th>Specification</th>
                        <th>Quantity Required</th>
                        <th>Quantity On Site</th>
                        <th>Difference</th>
                        <th>Inspection Remark</th>
                        <th>Quantity Y1</th>
                        <th>Quantity Y2</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="materialsTableBody">
                    <tr>
                        <td colspan="11" class="loading">Loading materials...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Manage Modal -->
    <div id="manageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Manage Inventory Settings</h2>
            
            <div class="manage-section">
                <div class="manage-item">
                    <h4>Courses</h4>
                    <div class="item-list" id="foldersList">
                        <div class="loading">Loading courses...</div>
                    </div>
                    <button onclick="openAddModal('folder')">Add Course</button>
                </div>
                
                <div class="manage-item">
                    <h4>Core Competencies</h4>
                    <div class="item-list" id="competenciesList">
                        <div class="loading">Loading competencies...</div>
                    </div>
                    <button onclick="openAddModal('competency')">Add Competency</button>
                </div>
                
                <div class="manage-item">
                    <h4>Categories</h4>
                    <div class="item-list" id="categoriesList">
                        <div class="loading">Loading categories...</div>
                    </div>
                    <button onclick="openAddModal('category')">Add Category</button>
                </div>
                
                <div class="manage-item">
                    <h4>Inspection Remarks</h4>
                    <div class="item-list" id="remarksList">
                        <div class="loading">Loading remarks...</div>
                    </div>
                    <button onclick="openAddModal('remark')">Add Remark</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="itemModalTitle">Add Item</h2>
            <div id="itemAlert"></div>
            
            <form id="itemForm">
                <div class="form-group">
                    <label for="itemName">Name *</label>
                    <input type="text" id="itemName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription">Description</label>
                    <textarea id="itemDescription" name="description" placeholder="Optional description"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Material Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="materialModalTitle">Add Material</h2>
            <div id="materialAlert"></div>
            
            <form id="materialForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="materialFolder">Folder</label>
                        <select id="materialFolder" name="folder_id">
                            <option value="">Select course</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="materialCompetency">Core Competency</label>
                        <select id="materialCompetency" name="competency_id">
                            <option value="">Select competency</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="materialCategory">Category</label>
                        <select id="materialCategory" name="category_id">
                            <option value="">Select category</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="materialRemark">Inspection Remark</label>
                        <select id="materialRemark" name="inspection_remark_id">
                            <option value="">Select remark</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="materialItem">Item Name *</label>
                    <input type="text" id="materialItem" name="item" required>
                </div>
                
                <div class="form-group">
                    <label for="materialSpecification">Specification</label>
                    <textarea id="materialSpecification" name="specification" placeholder="Item specification details"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="materialQuantityRequired">Quantity Required *</label>
                        <input type="number" id="materialQuantityRequired" name="quantity_required" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="materialQuantityOnSite">Quantity On Site *</label>
                        <input type="number" id="materialQuantityOnSite" name="quantity_on_site" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="materialQuantityY1">Quantity Y1</label>
                        <input type="number" id="materialQuantityY1" name="quantity_y1" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="materialQuantityY2">Quantity Y2</label>
                        <input type="number" id="materialQuantityY2" name="quantity_y2" min="0" value="0">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMaterialModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Material</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal confirmation-modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p id="confirmMessage">Are you sure you want to delete this item?</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentEditId = null;
        let currentEditType = null;
        let currentDeleteCallback = null;
        let allMaterials = []; // Store all materials for filtering
        const userType = "{{ user_type }}";  // Get user type from template

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadMaterials();
            loadFolders();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Main buttons
            if (userType === 'admin') {
                document.getElementById('manageBtn')?.addEventListener('click', openManageModal);
            }
            document.getElementById('addMaterialBtn').addEventListener('click', async () => await openMaterialModal());
            document.getElementById('folderSelect').addEventListener('change', loadMaterials);
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterMaterials);

            // Modal close buttons
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });

            // Form submissions
            document.getElementById('itemForm').addEventListener('submit', saveItem);
            document.getElementById('materialForm').addEventListener('submit', saveMaterial);

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        // API Functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return { success: false, message: 'Network error occurred' };
            }
        }

        // Load functions
        async function loadMaterials() {
            const folderId = document.getElementById('folderSelect').value;
            const url = folderId ? `/api/tvet/inventory/materials?folder_id=${folderId}` : '/api/tvet/inventory/materials';
            
            const result = await apiCall(url);
            
            if (result.success) {
                allMaterials = result.materials; // Store all materials
                displayMaterials(allMaterials); // Display them
            } else {
                const tbody = document.getElementById('materialsTableBody');
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #f44336;">Error loading materials</td></tr>';
            }
        }

        function displayMaterials(materials) {
            const tbody = document.getElementById('materialsTableBody');
            
            if (materials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">No materials found</td></tr>';
            } else {
                tbody.innerHTML = materials.map(material => {
                    const actionButtons = userType === 'admin' ? `
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editMaterial(${material.id})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteMaterial(${material.id}, '${material.item}')">Delete</button>
                        </div>
                    ` : '<div class="action-buttons">-</div>';
                    
                    return `
                        <tr>
                            <td>${material.competency_name || ''}</td>
                            <td>${material.category_name || ''}</td>
                            <td>${material.item}</td>
                            <td>${material.specification || ''}</td>
                            <td>${material.quantity_required}</td>
                            <td>${material.quantity_on_site}</td>
                            <td style="color: ${material.difference >= 0 ? '#4CAF50' : '#f44336'}">${material.difference >= 0 ? '+' : ''}${material.difference}</td>
                            <td>${material.inspection_remark || ''}</td>
                            <td>${material.quantity_y1}</td>
                            <td>${material.quantity_y2}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function filterMaterials() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayMaterials(allMaterials);
                return;
            }
            
            const filteredMaterials = allMaterials.filter(material => {
                return (
                    (material.item || '').toLowerCase().includes(searchTerm) ||
                    (material.competency_name || '').toLowerCase().includes(searchTerm) ||
                    (material.category_name || '').toLowerCase().includes(searchTerm) ||
                    (material.specification || '').toLowerCase().includes(searchTerm) ||
                    (material.inspection_remark || '').toLowerCase().includes(searchTerm)
                );
            });
            
            displayMaterials(filteredMaterials);
        }

        async function loadFolders() {
            const result = await apiCall('/api/tvet/inventory/folders');
            
            // Update folder select dropdown
            const select = document.getElementById('folderSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Folders</option>';
            
            if (result.success) {
                result.folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    select.appendChild(option);
                });
            }
            
            select.value = currentValue;
        }

        async function loadManageData() {
            const [folders, competencies, categories, remarks] = await Promise.all([
                apiCall('/api/tvet/inventory/folders'),
                apiCall('/api/tvet/inventory/competencies'),
                apiCall('/api/tvet/inventory/categories'),
                apiCall('/api/tvet/inventory/remarks')
            ]);

            displayManageList('foldersList', folders.success ? folders.folders : [], 'folder');
            displayManageList('competenciesList', competencies.success ? competencies.competencies : [], 'competency');
            displayManageList('categoriesList', categories.success ? categories.categories : [], 'category');
            displayManageList('remarksList', remarks.success ? remarks.remarks : [], 'remark');
        }

        async function loadMaterialFormData(isEditing = false) {
            const [folders, competencies, categories, remarks] = await Promise.all([
                apiCall('/api/tvet/inventory/folders'),
                apiCall('/api/tvet/inventory/competencies'),
                apiCall('/api/tvet/inventory/categories'),
                apiCall('/api/tvet/inventory/remarks')
            ]);

            populateSelect('materialFolder', folders.success ? folders.folders : [], isEditing);
            populateSelect('materialCompetency', competencies.success ? competencies.competencies : [], isEditing);
            populateSelect('materialCategory', categories.success ? categories.categories : [], isEditing);
            populateSelect('materialRemark', remarks.success ? remarks.remarks : [], isEditing);
        }

        function populateSelect(selectId, items, isEditing = false) {
            const select = document.getElementById(selectId);
            const firstOption = select.children[0];
            
            select.innerHTML = '';
            
            // Only add the default option if not editing
            if (!isEditing) {
                select.appendChild(firstOption);
            }
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });
        }

        function displayManageList(containerId, items, type) {
            const container = document.getElementById(containerId);
            
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No items found</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="item-entry">
                    <span class="item-name">${item.name}</span>
                    <div class="item-actions">
                        <button class="btn-edit" onclick="editItem('${type}', ${item.id}, '${item.name.replace(/'/g, "\\'")}', '${(item.description || '').replace(/'/g, "\\'")}')">Edit</button>
                        <button class="btn-delete" onclick="deleteItem('${type}', ${item.id}, '${item.name.replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Modal functions
        function openManageModal() {
            document.getElementById('manageModal').style.display = 'block';
            loadManageData();
        }

        function openAddModal(type) {
            currentEditType = type;
            currentEditId = null;
            
            document.getElementById('itemModalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('itemForm').reset();
            document.getElementById('itemAlert').innerHTML = '';
            document.getElementById('itemModal').style.display = 'block';
        }

        function editItem(type, id, name, description) {
            currentEditType = type;
            currentEditId = id;
            
            document.getElementById('itemModalTitle').textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('itemName').value = name;
            document.getElementById('itemDescription').value = description;
            document.getElementById('itemAlert').innerHTML = '';
            document.getElementById('itemModal').style.display = 'block';
        }

        async function openMaterialModal(materialData = null) {
            document.getElementById('materialModal').style.display = 'block';
            document.getElementById('materialAlert').innerHTML = '';
            
            if (materialData) {
                currentEditId = materialData.id;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                
                // First load the form data (dropdowns) - no default options when editing
                await loadMaterialFormData(true);
                
                // Then populate form fields including dropdowns
                document.getElementById('materialFolder').value = materialData.folder_id || '';
                document.getElementById('materialCompetency').value = materialData.competency_id || '';
                document.getElementById('materialCategory').value = materialData.category_id || '';
                document.getElementById('materialRemark').value = materialData.inspection_remark_id || '';
                document.getElementById('materialItem').value = materialData.item;
                document.getElementById('materialSpecification').value = materialData.specification || '';
                document.getElementById('materialQuantityRequired').value = materialData.quantity_required;
                document.getElementById('materialQuantityOnSite').value = materialData.quantity_on_site;
                document.getElementById('materialQuantityY1').value = materialData.quantity_y1;
                document.getElementById('materialQuantityY2').value = materialData.quantity_y2;
            } else {
                currentEditId = null;
                document.getElementById('materialModalTitle').textContent = 'Add Material';
                document.getElementById('materialForm').reset();
                await loadMaterialFormData(false);
            }
        }

        async function editMaterial(id) {
            const result = await apiCall('/api/tvet/inventory/materials');
            
            if (result.success) {
                const material = result.materials.find(m => m.id === id);
                if (material) {
                    await openMaterialModal(material);
                }
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').style.display = 'none';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentDeleteCallback = null;
        }

        // Save functions
        async function saveItem(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description')
            };

            const url = currentEditId ? 
                `/api/tvet/inventory/${getApiEndpoint(currentEditType)}/${currentEditId}` : 
                `/api/tvet/inventory/${getApiEndpoint(currentEditType)}`;
            
            const method = currentEditId ? 'PUT' : 'POST';
            
            const result = await apiCall(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (result.success) {
                showAlert('itemAlert', result.message, 'success');
                setTimeout(() => {
                    closeItemModal();
                    loadManageData();
                    if (currentEditType === 'folder') {
                        loadFolders();
                    }
                }, 1500);
            } else {
                showAlert('itemAlert', result.message, 'error');
            }
        }

        async function saveMaterial(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                folder_id: formData.get('folder_id') || null,
                competency_id: formData.get('competency_id') || null,
                category_id: formData.get('category_id') || null,
                inspection_remark_id: formData.get('inspection_remark_id') || null,
                item: formData.get('item'),
                specification: formData.get('specification'),
                quantity_required: parseInt(formData.get('quantity_required')),
                quantity_on_site: parseInt(formData.get('quantity_on_site')),
                quantity_y1: parseInt(formData.get('quantity_y1')) || 0,
                quantity_y2: parseInt(formData.get('quantity_y2')) || 0
            };

            const url = currentEditId ? 
                `/api/tvet/inventory/materials/${currentEditId}` : 
                '/api/tvet/inventory/materials';
            
            const method = currentEditId ? 'PUT' : 'POST';
            
            const result = await apiCall(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (result.success) {
                showAlert('materialAlert', result.message, 'success');
                setTimeout(() => {
                    closeMaterialModal();
                    loadMaterials();
                }, 1500);
            } else {
                showAlert('materialAlert', result.message, 'error');
            }
        }

        // Delete functions
        function deleteItem(type, id, name) {
            const endpoint = getApiEndpoint(type);
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${name}"?`;
            
            currentDeleteCallback = async () => {
                const result = await apiCall(`/api/tvet/inventory/${endpoint}/${id}`, { method: 'DELETE' });
                
                if (result.success) {
                    loadManageData();
                    if (type === 'folder') {
                        loadFolders();
                        loadMaterials();
                    }
                    closeConfirmModal();
                } else {
                    alert(result.message);
                }
            };
            
            document.getElementById('confirmModal').style.display = 'block';
        }

        function deleteMaterial(id, name) {
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${name}"?`;
            
            currentDeleteCallback = async () => {
                const result = await apiCall(`/api/tvet/inventory/materials/${id}`, { method: 'DELETE' });
                
                if (result.success) {
                    loadMaterials();
                    closeConfirmModal();
                } else {
                    alert(result.message);
                }
            };
            
            document.getElementById('confirmModal').style.display = 'block';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (currentDeleteCallback) {
                currentDeleteCallback();
            }
        });

        // Utility functions
        function getApiEndpoint(type) {
            const endpoints = {
                folder: 'folders',
                competency: 'competencies',
                category: 'categories',
                remark: 'remarks'
            };
            return endpoints[type];
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

        }

        
async function exportToPDF() {
    try {
        const result = await apiCall('/api/tvet/inventory/materials');

        if (!result.success) {
            alert('Failed to fetch materials for PDF export');
            return;
        }

        const materials = result.materials || [];

        // ðŸ”¹ Group by Core Competency
        const grouped = materials.reduce((acc, m) => {
            const key = m.competency_name || 'Unassigned Competency';
            acc[key] = acc[key] || [];
            acc[key].push(m);
            return acc;
        }, {});

        const report = document.createElement('div');
        report.style.background = '#fff';
        report.style.color = '#000';
        report.style.padding = '24px';
        report.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';

        report.innerHTML = `
            <div style="display:flex;justify-content:space-between;border:1px solid #000;height:110px;margin-bottom:14px;">
                <div style="width:20%;border-right:1px solid #000;display:flex;align-items:center;justify-content:center;">
                    <img src="/static/img/logo.png" style="max-height:90px;max-width:100px;">
                </div>
                <div style="width:60%;text-align:center;display:flex;flex-direction:column;justify-content:center;">
                    <h2 style="margin:0;font-size:18px;">Lonoy Agriventures Corp.</h2>
                    <div style="font-weight:600;">Technical-Vocational Education and Training (TVET)</div>
                    <div>Brgy. Lonoy, Sapian, Capiz</div>
                </div>
                <div style="width:20%;border-left:1px solid #000;"></div>
            </div>

            <h3 style="text-align:center;margin:16px 0;">TVET Inventory Report</h3>

            ${Object.entries(grouped).map(([competency, items]) => `
                <h4 style="margin-top:24px;padding-bottom:4px;border-bottom:2px solid #000;">
                    Core Competency: ${competency}
                </h4>

                <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:11px;page-break-inside:auto;">
                    <thead>
                        <tr>
                            <th style="border:1px solid #000;padding:6px;">Category</th>
                            <th style="border:1px solid #000;padding:6px;">Item</th>
                            <th style="border:1px solid #000;padding:6px;">Specification</th>
                            <th style="border:1px solid #000;padding:6px;text-align:right;">Qty Req</th>
                            <th style="border:1px solid #000;padding:6px;text-align:right;">Qty On Site</th>
                            <th style="border:1px solid #000;padding:6px;text-align:right;">Diff</th>
                            <th style="border:1px solid #000;padding:6px;">Inspection Remark</th>
                            <th style="border:1px solid #000;padding:6px;text-align:right;">Qty Y1</th>
                            <th style="border:1px solid #000;padding:6px;text-align:right;">Qty Y2</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(m => `
                            <tr style="page-break-inside:avoid;">
                                <td style="border:1px solid #000;padding:5px;">${m.category_name || ''}</td>
                                <td style="border:1px solid #000;padding:5px;">${m.item || ''}</td>
                                <td style="border:1px solid #000;padding:5px;">${m.specification || ''}</td>
                                <td style="border:1px solid #000;padding:5px;text-align:right;">${m.quantity_required}</td>
                                <td style="border:1px solid #000;padding:5px;text-align:right;">${m.quantity_on_site}</td>
                                <td style="border:1px solid #000;padding:5px;text-align:right;">
                                    ${m.difference >= 0 ? '+' : ''}${m.difference}
                                </td>
                                <td style="border:1px solid #000;padding:5px;">${m.inspection_remark || ''}</td>
                                <td style="border:1px solid #000;padding:5px;text-align:right;">${m.quantity_y1}</td>
                                <td style="border:1px solid #000;padding:5px;text-align:right;">${m.quantity_y2}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `).join('')}

            <div style="margin-top:28px;display:flex;justify-content:space-between;">
                <div><strong>Prepared by:</strong> Add Min</div>
                <div><strong>Approved by:</strong> Jeb Sama</div>
            </div>
        `;

        document.body.appendChild(report);

        await html2pdf().from(report).set({
            margin: 10,
            filename: 'tvet_inventory_report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        }).save();

        report.remove();
    } catch (err) {
        console.error(err);
        alert('Error exporting PDF');
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>
</html>

