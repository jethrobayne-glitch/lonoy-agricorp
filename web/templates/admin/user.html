<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Users</title>
</head>
<style>
    * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
    }

    body {
        height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        line-height: 1.5;
    }

    .main {
        width: 100vw;
        display: flex;
        height: 92vh;
    }

    .content {
        width: 85vw;
        padding: 20px;
    }

    .folders {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .inventory-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 5px;
        overflow: hidden;
    }

    .inventory-table th {
        background-color: #F9A825; /* amber-700 */
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
    }

    .inventory-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #ddd;
        font-size: 0.9rem;
        color: #333;
    }

    .inventory-table tbody tr:hover {
        background-color: #f5f5f5;
    }

    .inventory-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .inventory-table td:last-child {
        white-space: nowrap;
        min-width: 120px;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
    }

    .action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        font-family: inherit;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .edit-btn {
        background-color: #F9A825; /* amber-700 */
        color: white;
    }

    .delete-btn {
        background-color: #f44336;
        color: white;
    }

    .action-btn:hover {
        opacity: 0.8;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .close:hover,
    .close:focus {
        color: #000;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: #F9A825;
        box-shadow: 0 0 0 2px rgba(249, 168, 37, 0.2);
    }

    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        background-color: white;
        box-sizing: border-box;
    }

    .form-select:focus {
        outline: none;
        border-color: #F9A825;
        box-shadow: 0 0 0 2px rgba(249, 168, 37, 0.2);
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
    }

    .btn-primary {
        background-color: #F9A825;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-primary:hover,
    .btn-secondary:hover,
    .btn-danger:hover {
        opacity: 0.9;
    }

    .alert {
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 14px;
    }

    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .alert-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
</style>
<body>

    {% include 'partials/navbar.html' %}

    <div class="main">

        {% include 'partials/admin_sidebar.html' %}

        <div class="content">
            <div class="folders">
                <div>
                    <input type="search" id="searchInput" placeholder="Search users..." style="padding:5px 10px;font-size:1rem;border:1px solid #ccc;border-radius:5px;width:320px;">
                    <button onclick="searchUsers()" style="padding:6px 10px;font-size:1rem;background-color:#FF6F00;color:white;border:none;border-radius:5px;cursor:pointer;">Search</button>
                </div>

                <button onclick="openAddModal()" style="padding: 6px 10px;font-size: 1rem;background-color: #F9A825;color: white;border: none;border-radius: 5px;">Add User</button>
            </div>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Position</th>
                        <th>Password</th>
                        <th>Auth (admin,user)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}">
                        <td>{{ user.name or 'N/A' }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.position or 'N/A' }}</td>
                        <td>••••••••</td>
                        <td>{{ user.user_type }}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" 
                                        data-user-id="{{ user.id }}" 
                                        data-user-name="{{ user.name }}" 
                                        data-username="{{ user.username }}" 
                                        data-user-type="{{ user.user_type }}"
                                        data-user-position="{{ user.position or '' }}">Edit</button>
                                <button class="action-btn delete-btn" 
                                        data-user-id="{{ user.id }}" 
                                        data-user-name="{{ user.name }}">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add User</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div id="userModalAlert"></div>
            <form id="userForm">
                <div class="form-group">
                    <label class="form-label" for="userName">Full Name</label>
                    <input type="text" id="userName" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="userUsername">Username</label>
                    <input type="text" id="userUsername" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="userPosition">Position</label>
                    <input type="text" id="userPosition" name="position" class="form-input" placeholder="e.g., Manager, Administrator, Staff">
                </div>
                <div class="form-group">
                    <label class="form-label" for="userPassword">Password</label>
                    <input type="password" id="userPassword" name="password" class="form-input">
                    <small id="passwordHelp" style="color: #666; font-size: 12px;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="userType">User Type</label>
                    <select id="userType" name="user_type" class="form-select" required>
                        <option value="">Select user type</option>
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="userSubmitBtn">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete</h3>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div id="deleteModalAlert"></div>
            <p id="deleteMessage">Are you sure you want to delete this user?</p>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let isEditMode = false;

        // Initialize event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userName = this.getAttribute('data-user-name');
                    const username = this.getAttribute('data-username');
                    const userType = this.getAttribute('data-user-type');
                    const userPosition = this.getAttribute('data-user-position');
                    openEditModal(userId, userName, username, userType, userPosition);
                });
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userName = this.getAttribute('data-user-name');
                    openDeleteModal(userId, userName);
                });
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                searchUsers();
            });
        });

        function openAddModal() {
            isEditMode = false;
            currentUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userSubmitBtn').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordHelp').textContent = 'Password is required';
            clearAlert('userModalAlert');
            document.getElementById('userModal').style.display = 'block';
        }

        function openEditModal(userId, userName, username, userType, userPosition) {
            isEditMode = true;
            currentUserId = userId;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userSubmitBtn').textContent = 'Update User';
            
            // Populate form fields
            document.getElementById('userName').value = userName || '';
            document.getElementById('userUsername').value = username;
            document.getElementById('userPosition').value = userPosition || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
            document.getElementById('userType').value = userType;
            
            clearAlert('userModalAlert');
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
            currentUserId = null;
            isEditMode = false;
        }

        function openDeleteModal(userId, userName) {
            currentUserId = userId;
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete "${userName}"? This action cannot be undone.`;
            clearAlert('deleteModalAlert');
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentUserId = null;
        }

        // Handle form submission
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const userData = {
                name: formData.get('name'),
                username: formData.get('username'),
                position: formData.get('position'),
                password: formData.get('password'),
                user_type: formData.get('user_type')
            };

            // Remove empty password for edit mode
            if (isEditMode && !userData.password) {
                delete userData.password;
            }

            const submitBtn = document.getElementById('userSubmitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Processing...';
                submitBtn.disabled = true;

                const url = isEditMode ? `/api/users/${currentUserId}` : '/api/users';
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('userModalAlert', result.message, 'success');
                    setTimeout(() => {
                        closeUserModal();
                        location.reload(); // Refresh the page to show updated data
                    }, 1500);
                } else {
                    showAlert('userModalAlert', result.message, 'error');
                }
            } catch (error) {
                showAlert('userModalAlert', 'An error occurred. Please try again.', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        async function confirmDelete() {
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const originalText = deleteBtn.textContent;
            
            try {
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.disabled = true;

                const response = await fetch(`/api/users/${currentUserId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('deleteModalAlert', result.message, 'success');
                    setTimeout(() => {
                        closeDeleteModal();
                        location.reload(); // Refresh the page to show updated data
                    }, 1500);
                } else {
                    showAlert('deleteModalAlert', result.message, 'error');
                }
            } catch (error) {
                showAlert('deleteModalAlert', 'An error occurred. Please try again.', 'error');
            } finally {
                deleteBtn.textContent = originalText;
                deleteBtn.disabled = false;
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            
            rows.forEach(row => {
                const name = row.children[0].textContent.toLowerCase();
                const username = row.children[1].textContent.toLowerCase();
                const position = row.children[2].textContent.toLowerCase();
                const userType = row.children[4].textContent.toLowerCase();
                
                const matchFound = name.includes(searchTerm) || 
                                 username.includes(searchTerm) || 
                                 position.includes(searchTerm) ||
                                 userType.includes(searchTerm);
                
                row.style.display = matchFound ? '' : 'none';
            });
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function clearAlert(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const userModal = document.getElementById('userModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target === userModal) {
                closeUserModal();
            } else if (event.target === deleteModal) {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>